version: 2

models:
  - name: rpt_medical_groups_performance_annual
    description: >
      Annual AAC percentage and AWV claims reporting for operations team.
      Provides medical group and plan-level metrics, including visit counts, rates, and performance statuses.
    columns:
      - name: medical_group_id
        description: "Unique identifier for the medical group."
        tests:
          - not_null

      - name: plan_id
        description: "Unique identifier for the plan."
        tests:
          - not_null

      - name: date_year
        description: "Reporting year (integer)."
        tests:
          - not_null

      - name: medical_group_name
        description: "Name of the medical group."
        tests:
          - not_null

      - name: plan_name
        description: "Name of the insurance plan."
        tests:
          - not_null

      - name: visit_count
        description: "Total AWV visits for the medical group, plan, and year."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: patient_count
        description: "Total number of patients in the medical group plan panel for the year."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: visit_target_gap
        description: "Number of additional AWV visits needed to reach the performance target (e.g., 70%)."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0

      - name: remaining_patients_without_visit
        description: "Patients in the group and plan who have not received an AWV during the year."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0

      - name: mgp_awv_rate
        description: "AWV rate for the medical group plan: (AWV visits / total patients)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1

      - name: mgp_awv_performance_status
        description: >
          Performance status for the medical group plan.
          Typically values like 'Good', 'Needs Improvement', etc. (target >= 0.7).
        tests:
          - not_null
          - accepted_values:
              values: ['Good', 'Needs Improvement', 'Missing Data']

      - name: mg_awv_performance_status
        description: >
          Aggregated performance status for the entire medical group (across all plans).
          Typically values like 'Good', 'Needs Improvement', etc.
        tests:
          - not_null
          - accepted_values:
              values: ['Good', 'Needs Improvement', 'Missing Data']


  - name: rpt_medical_groups_performance_monthly
    description: >
      Monthly AAC percentage and cumulative AWV claims performance reporting for operations.
      Includes plan-level and aggregated group-level rates, counts, trends, and indicator statuses.
    columns:
      - name: medical_group_id
        description: "Unique identifier for the medical group."
        tests:
          - not_null

      - name: plan_id
        description: "Unique identifier for the plan."
        tests:
          - not_null

      - name: medical_group_name
        description: "Name of the medical group."
        tests:
          - not_null

      - name: plan_name
        description: "Name of the insurance plan."
        tests:
          - not_null

      - name: date_month
        description: "First day of the month (DATE) for the aggregation window."
        tests:
          - not_null

      - name: actions_available_start_month
        description: "Actions available at the start of the month (per group/plan)."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0}

      - name: actions_available_end_of_month
        description: "Actions available at the end of the month (per group/plan)."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0}

      - name: monthly_net_change_of_actions
        description: "Total net change in actions for the month."
        tests:
          - not_null

      - name: days_with_data
        description: "Number of days in the month for which data is available."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 1}

      - name: weekend_days
        description: "Number of weekend days (Saturday, Sunday) with data in the month."
        tests:
          - not_null

      # --- Plan-level measures ---

      - name: monthly_actions_completed
        description: "Actions completed in the month for this medical group and plan."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0}

      - name: monthly_actions_became_ineligible
        description: "Actions that became ineligible (lost opportunities) in the month for this group/plan."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0}

      - name: visit_count_per_month
        description: "AWV visits in this group/plan in the month."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0}

      - name: total_patient_count
        description: "Total number of patients in the plan panel."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0}

      - name: monthly_running_total_actions_completed
        description: "Cumulative completed actions as of the end of the month (plan level)."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0}

      - name: monthly_running_total_actions_became_ineligible
        description: "Cumulative lost opportunities as of end of the month (plan level)."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0}

      - name: cumulative_monthly_visits
        description: "Cumulative AWV visits up to and including the month (plan level)."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0}

      - name: visit_target_gap
        description: "AWV visits needed to reach 70% target (plan level)."
        tests:
          - dbt_utils.accepted_range: {min_value: 0}

      - name: remaining_patients_without_visit
        description: "Number of patients with no AWV visit by month end (plan level)."
        tests:
          - dbt_utils.accepted_range: {min_value: 0}

      # --- Plan-level rates & indicators ---

      - name: mgp_monthly_completion_rate
        description: "Monthly AAC% (completion rate) for the medical group plan."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0, max_value: 1}

      - name: mgp_running_monthly_completion_rate
        description: "Running (cumulative) AAC% for the plan."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0, max_value: 1}

      - name: mgp_cumulative_monthly_awv_visit_rate
        description: "Cumulative AWV visit rate for the plan."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0, max_value: 1}

      - name: mgp_monthly_lost_opportunity_rate
        description: "Lost opportunity rate (fraction of actions that became ineligible) for the plan/month."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0, max_value: 1}

      - name: mgp_running_monthly_lost_opportunity_rate
        description: "Cumulative lost opportunity rate for the plan."
        tests:
          - not_null
          - dbt_utils.accepted_range: {min_value: 0, max_value: 1}

      - name: mgp_cumulative_monthly_awv_performance_status
        description: "Status for cumulative monthly AWV performance of the plan (e.g., Good, Needs Improvement, Missing Data)."
        tests:
          - not_null
          - accepted_values:
              values: ['Good', 'Needs Improvement', 'Missing Data']

      - name: mgp_lost_opportunity_status
        description: "Opportunity loss status for plan (Low Loss / Moderate Loss / High Loss)."
        tests:
          - not_null
          - accepted_values:
              values: ['Low Loss', 'Moderate Loss', 'High Loss']

      - name: mgp_aac_performance_status
        description: "AAC% performance status for the plan (e.g., Meeting Target, Below Target, Significantly Below Target)."
        tests:
          - not_null
          - accepted_values:
              values: ['Meeting Target', 'Below Target', 'Significantly Below Target']

      - name: mgp_monthly_completion_rate_prev_month
        description: "AAC% for previous month (plan level)."

      - name: mgp_monthly_lost_opportunity_rate_prev_month
        description: "Lost opportunity rate for previous month (plan level)."

      - name: mgp_monthly_completion_rate_change_mom
        description: "Change in AAC% from previous month (plan level)."

      - name: mgp_lost_opportunity_rate_change_mom
        description: "Change in lost opportunity rate from previous month (plan level)."

      # --- Group-level monthly aggregates (aggregated across plans) ---

      - name: mg_monthly_completion_rate
        description: "Monthly AAC% (completion rate) for the aggregated medical group."
        tests:
          - dbt_utils.accepted_range: {min_value: 0, max_value: 1}

      - name: mg_running_monthly_completion_rate
        description: "Cumulative AAC% for the aggregated medical group."
        tests:
          - dbt_utils.accepted_range: {min_value: 0, max_value: 1}

      - name: mg_cumulative_monthly_awv_visit_rate
        description: "Cumulative AWV visit rate for the aggregated group."
        tests:
          - dbt_utils.accepted_range: {min_value: 0, max_value: 1}

      - name: mg_monthly_lost_opportunity_rate
        description: "Aggregated group-level lost opportunity rate for the month."
        tests:
          - dbt_utils.accepted_range: {min_value: 0, max_value: 1}

      - name: mg_running_monthly_lost_opportunity_rate
        description: "Cumulative lost opportunity rate for the group."
        tests:
          - dbt_utils.accepted_range: {min_value: 0, max_value: 1}

      - name: mg_cumulative_monthly_awv_performance_status
        description: "AWV performance status for the group (Good / Needs Improvement / Missing Data)."
        tests:
          - accepted_values:
              values: ['Good', 'Needs Improvement', 'Missing Data']

      - name: mg_lost_opportunity_status
        description: "Opportunity loss status for the group (Low Loss / Moderate Loss / High Loss)."
        tests:
          - accepted_values:
              values: ['Low Loss', 'Moderate Loss', 'High Loss']

      - name: mg_aac_performance_status
        description: "AAC% performance status (Meeting Target/Below Target/Significantly Below Target) for the group."
        tests:
          - accepted_values:
              values: ['Meeting Target', 'Below Target', 'Significantly Below Target']

      - name: mg_monthly_completion_rate_prev_month
        description: "AAC% for previous month (aggregated group)."

      - name: mg_monthly_lost_opportunity_rate_prev_month
        description: "Lost opportunity rate for previous month (aggregated group)."

      - name: mg_monthly_completion_rate_change_mom
        description: "Change in AAC% from previous month (aggregated group)."

      - name: mg_monthly_lost_opportunity_rate_change_mom
        description: "Change in lost opportunity rate from previous month (aggregated group)."
